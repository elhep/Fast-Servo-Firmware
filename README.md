# Fast Servo minimal hardware launching repo

Inside this repository you'll find Vivado and Vitis projects that allow to perform initial testing of the Fast Servo device.
Repo is divided into two "workspaces" - Vivado and Vitis. This allows to separate output files generated by each Xilinx toolchain.

Vivado folder contains a TCL script for project recreation and all of the needed source files in _vivado/src_.
However, Vitis folder contains whole workspace that was generated by Vitis. Cruicial files for software development are located
in _vitis/fast_servo/src_ . When it comes to hardware description generated by Vivado it can be found in _vitis/hw_desc_ as design_1_wrapper.xsa. 
Be careful, though, as this file needs to be overwritten each time a new hardware is built in Vivado. 

## Building gateware

A Vivado installation is needed (this repository was developed on 2020.2 version of Vivado).

  * launch Vivado
  * in TCL console change directory to fast-servo-firmware/vivado
  * type ```source build.tc```

The block design with Zynq and project should be generated with all of the Verilog modules connected. 
  * make sure that "design_1_wrapper.v" is set as a top module
  * generate block design
  * launch synthesis and implementation, generate bitstream

Now the hardware description needs to be exported (the flow may differ with different Vivado versions; below for Vivado 2020.2):
  * from the top menu bar select File > Export > Export Hardware
  * a new window should pop up; click "Next"
  * select an option to include bitstream in platform and click Next
  * leave the XSA file name default, but set the file's export path to fast-servo-firmware/vitis/hw_desc and click "Next"
  * if prompted with question whether to overwrite the existing file, choose Yes

The hardware platform should be succesfully exported

## Firmware development

  * launch Vitis
  * select Vitis workspace (fast-servo-firmware/vitis)
  * now a fast servo project should be opened
  * to update hardware description click on *fast_servo_platform* in explorer window with left mouse key and select *Update Hardware Specification*
  * software/firmware project now should be ready to run

## Firmware support

Firmware used in Vitis project contains a set of files that provide access to the majority of Fast Servo functionalities. It can be viewed as a simple board support package.
In *config.h* one can find a number of definitions used across the whole project (i.e. pin number assignments) and *fast_srevo_main.c* is a main project file.
*fast_servo_main.c* contains among others:
  * initialization code for a number of peripherals used, i.e. GPIOs, Si5340 I2C or converters SPIs
  * implementation of word aligning algorithm used to set proper IDELAYs on ADC LTC2195 data ports
  * creation of a saw-shaped signal on DAC 9117 outputs
  * reading values from LTC2196 ADC
  * reading values from an aux ADC
  * setting outputs on aux DAC
  * reading and setting values on GPIO and LVDS headers

Each file has a *DEBUG_PRINT* preprocessor definition that allows to turn on or off additional debugging printing (by default it is turned on).

### Additional Tests

  * to test Ethernet PHY, an example project with Echo Server was used
  * to test SDCard, one may create FSBL and flash it onto the SDCard together with an app, close a MODE switch and try to boot the device from SDCard after power-cycling
  * to test LM75 one may use an external I2C controller (i.e. Analog Discovery 2) - connect it to EEM I2C and try to communicate with LM75
